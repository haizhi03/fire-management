**软件设计说明书**

**团队名称：软件工程CD13组**

**团队成员：\__ 李宇浩 ，**

**\__ 汪芮 ，**

**黄菲琪 ，**

**李寅森 ，**

**林远灏 ，**

**黄海志**

**时间：2025年11月14日**

**Version：1.0**

目录

[1\. 引言 1](#_Toc214014435)

[1.1编制目的 1](#_Toc214014436)

[1.2项目背景 1](#_Toc214014437)

[1.3 定义和缩写词 2](#_Toc214014438)

[1.4 参考资料 2](#_Toc214014439)

[2.总体设计 3](#_Toc214014440)

[2.1 系统架构设计 3](#_Toc214014441)

[2.1.1 总体设计 3](#_Toc214014442)

[2.1.2 详细设计 3](#_Toc214014443)

[2.2 系统组件设计 4](#_Toc214014444)

[2.2.1 总体设计 4](#_Toc214014445)

[2.2.2 详细设计 4](#_Toc214014446)

[2.3 数据库设计 6](#_Toc214014447)

[2.3.2 详细设计 6](#_Toc214014448)

[2.4 接口设计 7](#_Toc214014449)

[2.4.1 外部接口设计 7](#_Toc214014450)

[2.4.2 内部接口设计 8](#_Toc214014451)

[2.5 用户界面设计 9](#_Toc214014452)

[2.5.1 设计原则 9](#_Toc214014453)

[2.5.2 各端界面详细设计 9](#_Toc214014454)

[2.6 关键算法技术选型 11](#_Toc214014455)

[2.6.1 数据清洗与空间去重算法 11](#_Toc214014456)

[2.6.2AI消防栓识别算法 11](#_Toc214014457)

[2.6.3 离线路径规划算法 12](#_Toc214014458)

[2.6.4 增量数据同步算法 12](#_Toc214014459)

[3 详细设计 13](#_Toc214014460)

[3.1 系统组件详细设计 13](#_Toc214014461)

[3.1.1 客户端组件设计 13](#_Toc214014462)

[3.1.2 服务端组件设计 14](#_Toc214014463)

[3.1.3 数据支撑组件设计 14](#_Toc214014464)

[3.2 数据库详细设计 14](#_Toc214014465)

[3.2.1 核心表结构设计 15](#_Toc214014466)

[3.2.2 索引设计 17](#_Toc214014467)

[3.2.3 数据库优化策略 17](#_Toc214014468)

[3.3 用户界面详细设计 18](#_Toc214014469)

[3.3.1 移动终端界面设计（重点面向消防战士和采集人员） 18](#_Toc214014470)

[3.3.2 Web管理端界面设计（面向系统管理员） 19](#_Toc214014471)

[3.4 接口详细设计 19](#_Toc214014472)

[3.4.1 外部接口设计 19](#_Toc214014473)

[3.4.2 内部接口设计 20](#_Toc214014474)

[3.5 算法详细设计 23](#_Toc214014475)

[3.5.1 空间数据去重算法 23](#_Toc214014476)

[3.5.2 AI图像识别算法（消防栓检测） 23](#_Toc214014477)

[3.6 异常和错误详细设计 24](#_Toc214014478)

[3.6.1 全局异常处理机制 24](#_Toc214014479)

[3.6.2 自定义异常类体系 24](#_Toc214014480)

[3.6.3 错误码规范 24](#_Toc214014481)

[3.6.4 特定场景异常处理 25](#_Toc214014482)

# 引言

本节旨在为《消防软件系统详细设计说明书》的后续章节提供必要的背景、目标与术语基础，帮助读者快速理解文件编制目的、项目缘起、关键概念及引用依据。

## 1.1编制目的

本说明书依据《需求规格说明书》与《概要设计说明书》进一步细化，用于：

1.  向开发、测试、运维及项目管理团队提供统一的技术蓝图，确保模块接口、数据结构、算法选型与界面实现可追溯、可验证、可复用；
2.  作为代码编写、单元测试、集成测试与验收的直接输入，降低因理解偏差导致的返工风险；
3.  为后续迭代（全省推广、AI 模型升级、新增设施类型）预留扩展点，并明确性能基线与安全红线；
4.  供第三方测评机构、消防支队信息科及业主单位进行设计评审与合规性检查。

## 1.2项目背景

中山市消防救援支队在“智慧城市”与“数字消防”背景下，面临消防栓等基础数据底数不清、状态更新滞后、现场查询手段缺乏等问题。传统纸质台账与离线 Excel 无法满足灭火救援“秒级响应”要求。  
为此，中山市消防救援支队联合××科技公司启动“消防软件系统”建设项目，构建“云-管-端”混合架构：

云端提供 AI 识别、大数据去重、统计分析等能力；通信层实现加密传输与离线自适应同步；终端覆盖数据采集员（移动采集 App）、消防战士（离线查询 App）及系统管理员（Web 管理端）。

项目分两期：一期聚焦中山市中心城区消防栓，二期向镇区及全省推广，并扩展至消防水池、微型消防站等设施。

## 1.3 定义和缩写词

AI Artificial Intelligence，人工智能  
AOI Area of Interest，兴趣区域  
App Application，移动应用程序  
B/S Browser/Server，浏览器/服务器模式  
C/S Client/Server，客户端/服务器模式  
DBSCAN Density-Based Spatial Clustering of Applications with Noise，密度聚类算法  
EPSG:4326 WGS84 地理坐标系编码  
FAB Floating Action Button，悬浮操作按钮  
GIS Geographic Information System，地理信息系统  
GPS Global Positioning System，全球定位系统  
JWT JSON Web Token，轻量级身份令牌  
KPI Key Performance Indicator，关键绩效指标  
min_samples DBSCAN 最小样本数参数  
NMS Non-Maximum Suppression，非极大值抑制  
OSM OpenStreetMap，开源街景地图  
OSRM Open Source Routing Machine，开源路径规划引擎  
PostGIS PostgreSQL 空间扩展  
RBAC Role-Based Access Control，基于角色的访问控制  
REST Representational State Transfer，表述性状态转移  
ROI Region of Interest，感兴趣区域  
SDK Software Development Kit，软件开发包  
SHA-256 Secure Hash Algorithm 256 位  
SQLite 轻量级嵌入式关系数据库  
ST_DWithin PostGIS 空间函数：判断两点是否在给定距离内  
TLS Transport Layer Security，传输层安全协议  
UUID Universally Unique Identifier，通用唯一标识符  
WFS Web Feature Service，OGC 矢量要素服务  
WMS Web Map Service，OGC 地图栅格服务  
YOLOv8 You Only Look Once v8，目标检测模型第 8 版

## 1.4 参考资料

  
\[1\] GB/T 28181-2022 公共安全视频监控联网系统信息传输、交换、控制技术要求.  
\[2\] GB 50440-2021 城市消防远程监控系统技术规范.  
\[3\] ISO/IEC 25010:2011 系统与软件工程——系统与软件质量模型.  
\[4\] OpenAPI Specification 3.0.3，2021-02.  
\[5\] PostGIS 3.3 官方文档，2023.  
\[6\] Spring Cloud 2023.x 官方参考指南.  

# 2.总体设计

## 2.1 系统架构设计

### 2.1.1 总体设计

本系统架构严格遵循需求规格说明书中 “云 - 管 - 端” 混合架构理念，以 “效率优先、稳定可靠、适配消防业务场景” 为核心设计原则，构建分层解耦的分布式架构体系。架构整体分为云端服务层、通信传输层、终端应用层三大核心层级，各层级通过标准化接口协同工作，既满足数据采集、处理、查询的全流程高效流转，又适配消防场景中网络不稳定、紧急操作、多角色协同的特殊需求。云端服务层承担数据存储、业务逻辑处理、AI 计算与统计分析功能，为全系统提供核心算力支持；通信传输层负责跨端数据加密传输与协议适配，保障数据安全性与传输稳定性；终端应用层针对不同用户角色提供定制化操作入口，覆盖数据采集、现场查询、系统管理等核心场景。同时，架构设计充分考虑离线适配能力、跨平台兼容性与可扩展性，预留 AI 识别算法迭代、功能模块扩展的接口，确保系统能随业务需求升级持续优化。

### 2.1.2 详细设计

**云端服务层**

采用微服务架构拆分核心业务模块，部署于云服务器集群，支持弹性扩容以应对高并发查询与数据采集峰值。核心包含五大微服务：数据采集服务（集成 AI 识别 API 调用、众包数据接收接口）、数据处理服务（负责数据清洗去重、审核流转）、地图服务（对接第三方地图 SDK，提供空间查询与可视化能力）、用户权限服务（基于 RBAC 模型实现角色权限管控）、统计分析服务（支撑局长看板的指标计算与热力图生成）。服务端采用 Spring Boot/Spring Cloud 框架开发，确保接口响应效率满足 “常规操作平均响应时间 < 2 秒” 的性能需求；同时集成分布式缓存 Redis，对高频访问的消防栓基础数据、地图瓦片数据进行缓存，进一步提升响应速度。

**通信传输层**

作为 “云 - 端” 数据交互的核心枢纽，采用 “加密传输 + 协议标准化 + 离线适配” 三重设计。数据传输统一使用 HTTPS/TLS 协议加密，符合安全性需求中 “通信加密” 要求；前后端交互采用 RESTful API 规范，数据交换格式统一为 JSON，确保跨平台、跨终端的兼容性。针对消防救援现场网络信号不佳的场景，设计离线数据暂存与同步机制：终端设备在离线状态下可本地缓存采集数据、查询结果，待重新联网后自动触发数据同步，同步过程采用增量传输策略，仅上传新增或变更数据，减少带宽占用。此外，通信层支持断点续传功能，保障大文件（如消防栓现场照片）传输的完整性。

**终端应用层**

针对三类用户角色设计定制化终端：数据采集端基于 Android 8.0+、iOS 12.0 + 开发移动 App，支持离线采集、现场拍照定位、任务接收等功能，界面设计遵循 “操作便捷” 原则，按钮尺寸放大、流程引导清晰，适配采集员户外作业场景；消防查询端同样为移动 App，以地图为核心交互载体，简化操作流程，仅保留 “周边查询、详情查看” 核心功能，优化色彩对比度与屏幕亮度适配，确保户外强光下可视性，同时优化 GPS 定位响应速度，保障位置查询延迟 < 1 秒；Web 管理端采用响应式设计，支持 Chrome、Firefox 等主流浏览器，提供数据审核、用户管理、看板查看等功能，界面布局注重信息密度与操作效率，满足系统管理员宏观管控需求。终端与云端通过通信传输层实现数据同步，本地缓存采用 SQLite 数据库，确保离线状态下核心功能可用。

## 2.2 系统组件设计

### 2.2.1 总体设计

系统组件设计以 “功能模块化、组件高内聚低耦合” 为原则，基于功能性需求拆解为六大核心组件：数据采集组件、数据处理组件、地图可视化组件、用户权限组件、统计分析组件、系统配置组件。各组件通过标准化接口实现交互，既独立承担专项业务功能，又协同完成 “采集 - 处理 - 存储 - 应用” 的全流程闭环。组件设计充分适配用户角色需求：针对消防战士 “快速操作、高压环境使用” 的特点，优化地图可视化组件与查询组件的响应速度和易用性；针对数据采集员 “高效录入、离线作业” 的需求，强化数据采集组件的离线存储与流程引导能力；针对系统管理员 “宏观管控、高效审核” 的需求，完善统计分析组件与权限组件的功能覆盖。同时，组件设计严格遵循非功能性需求，确保性能、可靠性、安全性等指标达标，如数据处理组件的去重算法保障数据准确性，用户权限组件的访问控制机制防范越权操作。

### 2.2.2 详细设计

**数据采集组件**

核心职责是实现 “AI 自动采集 + 人工众包采集” 的多元数据采集能力，完全覆盖需求中 FUNC-010 优先级 P0 需求。AI 自动采集模块集成车辆摄像头视频流解析功能，通过调用图像识别 API 实时识别消防栓，同步采集位置（GPS 定位）、照片、置信度等数据，支持置信度阈值配置（默认低于 90% 的结果标记为待审核）；人工众包采集模块提供拍照上传、位置自动定位（支持手动修正）、属性信息录入（工作压力、地址描述等可选字段）功能，界面设计采用 “分步引导” 模式，降低采集员操作门槛。组件内置离线存储机制，离线状态下采集的数据暂存于本地 SQLite 数据库，联网后自动上传，上传时支持断点续传，避免数据丢失。此外，组件支持采集任务分配功能，系统管理员可通过 Web 端下发采集区域与任务清单，采集员 App 接收后显示任务进度，确保采集工作有序推进。

**数据处理组件**

作为数据质量保障的核心组件，涵盖数据清洗去重、审核流转、入库存储三大核心功能，对应 FUNC-011（P0）、FUNC-012（P1）需求。数据清洗去重模块基于地理位置信息实现智能去重：采用 Haversine 公式计算消防栓坐标之间的直线距离，默认将距离小于 10 米（与地图标注精度一致）的记录判定为重复数据，支持自动合并（保留置信度 / 完整性更高的记录）或标记重复（供管理员手动处理）；数据审核模块提供 Web 端审核界面，管理员可查看待审核数据（含 AI 低置信度、人工上报数据）的照片、位置、属性信息，支持 “通过、打回、废弃” 操作，打回数据需填写原因，采集员 App 接收后可重新提交；入库存储模块负责将审核通过的数据写入 PostgreSQL 主数据库，同步更新数据状态（待检查→正常 / 损坏）与最后检查时间，同时触发缓存更新，确保查询端能获取最新数据。组件处理逻辑支持配置化，如去重距离阈值、审核流程节点可通过系统配置组件调整，提升灵活性。

**地图可视化组件**

聚焦数据查询与可视化需求（FUNC-020、FUNC-021、FUNC-022、FUNC-023），为消防查询端与 Web 管理端提供地图渲染、位置查询、状态展示等核心能力。组件集成 Mapbox GL JS/Leaflet 地图 SDK，支持电子地图缩放、平移、定位等基础操作，消防栓位置以标准化图标标注，图标颜色根据状态动态切换（绿色 - 正常、红色 - 损坏、黄色 - 待检查），直观呈现设施状态。周边查询功能支持用户输入位置（或自动获取当前 GPS 位置），设置查询半径（默认 500 米，支持 100-1000 米自定义），系统快速筛选范围内消防栓并高亮显示，同时返回距离排序结果；详情查看功能支持点击图标弹出信息窗口，展示照片、地址、工作压力、采集来源等信息，照片支持放大查看，满足消防战士现场确认需求。组件优化了地图加载速度，采用瓦片预加载与懒加载结合的方式，确保客户端响应时间 < 1 秒，同时适配户外强光场景，支持亮度调节与夜间模式切换。

**用户权限组件**

基于 RBAC（基于角色的访问控制）模型设计，实现用户管理、角色分配、权限管控功能，对应 FUNC-031（P1）需求与安全性需求。组件支持三类预设角色：系统管理员（全权限，含用户管理、数据审核、系统配置）、数据采集员（仅数据采集、任务查看权限）、消防员（只读权限，含地图查询、详情查看），支持自定义角色与权限分配，满足复杂管理场景。用户管理模块支持管理员在 Web 端创建、编辑、禁用用户账号，密码存储采用加盐哈希（SHA-256 算法）处理，符合安全性要求；权限校验模块在各组件接口调用时自动生效，验证用户角色是否具备操作权限，防止越权访问（如消防员无法进入数据审核界面）。组件同时支持登录状态管理，移动端登录后默认保持 7 天有效，Web 端支持自动登出（闲置 30 分钟），进一步保障系统安全。

**统计分析组件**

核心支撑局长看板功能（FUNC-030，P0），负责数据指标计算、可视化展示与统计报告生成。组件基于采集与审核后的有效数据，实时计算核心指标：消防栓总数、区域分布（按行政区划拆分）、正常 / 损坏 / 待检查比例、采集进度（按计划采集量与实际完成量对比）、AI 识别准确率等。可视化展示采用多种图表形式：区域分布以热力图呈现，状态比例以环形图展示，采集进度以折线图动态更新，所有图表支持钻取功能（如点击热力图区域查看该区域详细数据）。组件支持数据导出功能，管理员可将统计结果导出为 Excel 格式，用于向上级汇报；同时支持自定义统计维度（如按采集来源、时间周期统计），满足灵活分析需求。组件优化了计算性能，采用定时预计算 + 增量更新的方式，避免实时计算导致的响应延迟，确保看板数据更新延迟 < 5 分钟。

## 2.3 数据库设计

2.3.1 总体设计

数据库设计严格遵循需求规格说明书中的数据定义要求，采用 “主数据库 + 本地缓存数据库” 的混合存储架构，核心目标是保障数据存储的安全性、查询的高效性与场景适配性。主数据库选用 PostgreSQL，搭配 PostGIS 空间扩展，专门优化地理空间数据的存储与查询性能，满足消防栓位置查询、周边筛选等核心场景需求；本地缓存数据库采用 SQLite，适配移动端离线作业场景，实现采集数据本地暂存与常用查询结果缓存。数据库整体设计遵循 “第三范式”，减少数据冗余，同时通过合理的索引设计、分表策略提升查询效率；数据安全方面，落实密码加盐哈希存储、数据传输 HTTPS 加密、基于角色的访问控制等要求，保障数据全生命周期安全。此外，数据库设计预留扩展接口，支持后续消防设施类型扩展（如新增消防水池、灭火器等）与数据字段新增，提升系统可维护性。

### 2.3.2 详细设计

**主数据库设计**

主数据库采用 PostgreSQL 14 + 版本，启用 PostGIS 3.0 + 扩展，核心数据表设计严格对应需求中的核心数据字典，同时补充关联表以支撑业务流程：

**核心数据表（消防栓信息表 t_hydrant）**：字段完全覆盖数据字典要求，包括消防栓 ID（UUID 类型，主键）、经度（DECIMAL (10,7)，非空）、纬度（DECIMAL (10,7)，非空）、地址描述（VARCHAR (255)，可选）、照片 URL（VARCHAR (500)，非空，支持多照片存储，以逗号分隔 URL）、工作压力（VARCHAR (50)，可选）、状态（ENUM (' 正常 ',' 损坏 ',' 待检查 ')，默认 ' 待检查 '）、采集来源（ENUM ('AI 识别 ',' 人工上报 ')，非空）、置信度（FLOAT，仅 AI 采集时非空，取值 0-1）、最后检查时间（DATETIME）、是否已合并（BOOLEAN，默认 False）。空间数据存储采用 PostGIS 的 GEOMETRY (POINT, 4326) 类型，将经度、纬度转换为空间点坐标，优化周边查询、区域筛选等空间操作的效率。

**关联数据表**：包括用户表（t_user）、角色表（t_role）、权限表（t_permission）、采集任务表（t_collection_task）、数据审核记录表（t_audit_record）。用户表存储用户账号、加盐哈希后的密码、角色 ID 等信息；角色表与权限表通过关联表（t_role_permission）实现多对多关系，支撑 RBAC 权限模型；采集任务表记录任务 ID、分配区域、负责人、完成进度等信息，关联采集员与采集数据；数据审核记录表存储审核 ID、数据 ID、审核人、审核结果、审核时间、备注等信息，便于追溯审核流程。

**索引设计**：为提升查询效率，建立多维度索引：t_hydrant 表的主键索引（消防栓 ID）、空间索引（GEOMETRY 字段）、状态索引（状态字段）、区域索引（经度 + 纬度联合索引）；用户表的账号索引（唯一索引）、角色 ID 索引；采集任务表的负责人 ID 索引、任务状态索引。空间索引采用 PostGIS 的 GIST 索引，使周边查询、区域筛选等操作的时间复杂度从 O (n) 降至 O (log n)，保障查询响应时间 < 2 秒。

**本地缓存数据库设计**

移动端本地缓存数据库采用 SQLite 3.0 + 版本，设计目标是适配离线作业场景，存储内容包括：

**离线采集数据表（local_hydrant）**：结构与主数据库 t_hydrant 表一致，用于暂存离线状态下采集的消防栓数据，包含临时 ID、采集时间、是否已上传等字段，联网后根据临时 ID 与主数据库数据进行匹配同步，避免重复上传。

**常用查询结果缓存表（local_query_cache）**：存储用户近期查询的周边消防栓数据，包含查询条件（位置、半径）、查询时间、结果数据（关联 local_hydrant 表的临时 ID 或主数据库消防栓 ID），缓存有效期默认 24 小时，过期自动清理，减少重复查询时的网络请求。

**本地配置表（local_config）**：存储 App 本地配置信息，如登录状态、亮度设置、离线缓存开关、查询半径默认值等，保障 App 个性化使用与离线功能正常运行。

**数据安全与备份设计**

数据安全方面，除密码加盐哈希存储、通信 HTTPS 加密外，主数据库采用定期备份策略：每日凌晨执行全量备份，每 6 小时执行增量备份，备份文件存储于加密服务器，保留 30 天备份记录，防止数据丢失。同时，数据库开启访问日志审计功能，记录所有数据操作（新增、修改、删除）的操作人、操作时间、操作内容，便于安全审计与故障追溯。本地缓存数据库采用加密存储，移动端数据文件通过 AES 算法加密，密钥与设备绑定，防止本地数据泄露。

## 2.4 接口设计

### 2.4.1 外部接口设计

外部接口是指系统与外部系统、设备或服务之间的交互接口，主要包括地图服务、定位服务、AI识别服务等。

|     |     |     |     |
| --- | --- | --- | --- |
| 接口类别 | 接口名称 | 接口描述 | 技术实现 |
| **地图服务接口** | 在线地图渲染 | 用于在Web端和移动端展示底图与设施位置 | Web端：Leaflet / OpenLayers / Mapbox GL JS  <br>移动端：Mapbox GL Mobile / Maplibre GL Native |
| **GPS定位接口** | 设备定位服务 | 调用移动设备操作系统提供的定位功能，获取当前位置 | Android：LocationManager / FusedLocationProviderClient  <br>iOS：CoreLocation |
| **AI识别服务接口** | 图像识别API | 对采集的消防栓图像进行自动识别与分类 | 可集成第三方视觉AI服务（如百度AI、阿里云视觉智能）或自建模型服务 |
| **第三方导航接口** | 系统地图跳转 | 在离线端提供“导航”按钮，跳转至系统默认地图App | 调用系统Intent / URL Scheme（如：geo:） |
| **文件存储接口** | 静态资源访问 | 提供照片、离线数据包等文件的下载服务 | 使用Nginx或对象存储（如MinIO）提供HTTP/HTTPS访问 |

### 2.4.2 内部接口设计

内部接口是指系统内部各模块之间的交互接口，主要基于RESTful API实现，用于前后端数据通信、模块间数据同步等。

|     |     |     |     |     |     |
| --- | --- | --- | --- | --- | --- |
| 模块类别 | 接口名称 | 功能描述 | 请求方法 | 示例路径 | 数据格式 |
| **用户认证** | 用户登录 | 用户登录并获取Token | POST | /api/auth/login | JSON |
|     | Token刷新 | 刷新JWT令牌 | POST | /api/auth/refresh | JSON |
| **设施管理** | 设施列表查询 | 分页查询消防设施 | GET | /api/facilities | JSON |
|     | 设施详情获取 | 根据ID获取设施详情 | GET | /api/facilities/{id} | JSON |
|     | 设施新增/修改 | 新增或修改设施信息 | POST/PUT | /api/facilities | JSON |
|     | 设施删除 | 删除指定设施 | DELETE | /api/facilities/{id} | \-  |
| **任务管理** | 任务列表获取 | 获取采集员任务列表 | GET | /api/tasks | JSON |
|     | 任务状态更新 | 更新任务执行状态 | PUT | /api/tasks/{id}/status | JSON |
| **数据同步** | 数据上传 | 采集端上传设施数据 | POST | /api/sync/upload | Multipart |
|     | 离线包检查 | 检查是否有新离线包 | GET | /api/sync/check-update | JSON |
|     | 离线包下载 | 下载离线数据包 | GET | /api/sync/download-package | Binary |
| **地图服务** | 地图瓦片服务 | 提供地图瓦片（WMS） | GET | /geoserver/wms | Image |
|     | 设施矢量服务 | 提供设施矢量数据（WFS） | GET | /geoserver/wfs | GML/JSON |
| **统计分析** | 看板数据获取 | 获取首页统计看板数据 | GET | /api/dashboard/stats | JSON |
|     | 设施状态统计 | 按状态统计设施数量 | GET | /api/stats/status | JSON |

## 2.5 用户界面设计

### 2.5.1 设计原则

**用户为中心：** 针对三类核心用户（消防战士、数据采集员、系统管理员）的特定工作场景和认知负荷进行差异化设计。

**清晰与直观：** 界面布局遵循格式塔原则，信息层次分明。使用消防领域通用图标和色彩编码（如红色代表警报/损坏），确保信息传递无歧义。

**效率优先：** 核心功能操作路径最短，减少不必要的点击和跳转。特别是在消防查询端，确保“打开App -> 定位 -> 查看周边消防栓”的流程在3步内完成。

**鲁棒性与反馈：** 对所有用户操作提供即时、明确的反馈（如成功、失败、加载中）。在网络异常、数据缺失等边界情况下，给出清晰的指引而非报错代码。

**一致性：** 跨平台（Web、Android、iOS）保持一致的交互逻辑和视觉风格，建立统一的设计语言系统。

### 2.5.2 各端界面详细设计

**（1）数据采集端（移动App）**

①主界面 / 地图采集视图：

布局： 全屏地图作为底图，悬浮在顶部的是关键信息栏（当前登录用户、同步状态），底部为常驻功能栏（FAB）。

核心交互：

快速采集按钮（FAB）： 一个醒目的“+”号按钮悬浮在屏幕右下角。点击后，首先调用摄像头，拍摄后自动获取当前GPS位置，并跳转至表单填写页面。

任务列表入口： 屏幕左下角为任务列表图标，点击后进入任务管理界面。

视觉： 地图样式简洁，突出道路和街区，避免信息过载。

②任务管理界面：

布局： 以上下结构的列表形式展示任务。

内容： 每个任务项显示“任务区域”（如“东区街道-001网格”）、“进度状态”（如“3/10”，并使用进度条可视化）、“截止日期”。

交互： 点击任务项可进入该任务的专用地图视图，地图上会高亮显示待采集的区域范围。

③数据采集表单界面：

布局： 从上至下的垂直表单，分组清晰。

位置信息组： 自动填充的经纬度，并提供“重新定位”按钮。

设施照片组： 以大缩略图形式展示已拍摄的照片，并标注“整体环境照”、“接口特写照”。提供“重拍”、“从相册选择”按钮。

属性信息组： 使用下拉选择器选择“状态”（正常/损坏/待检查）、输入框填写“工作压力”、文本框填写“地址备注”。

操作： 底部有“暂存为草稿”和“提交”按钮。

**（2）消防离线端（移动App）**

①主界面 / 离线地图视图：

布局： 全屏地图，UI元素极度精简。

核心交互：

定位按钮： 屏幕右上角固定定位按钮，点击后地图中心快速移动至当前GPS位置。

搜索/查询面板： 从屏幕顶部边缘下滑，可呼出搜索栏。支持输入地址或直接显示“周边500米消防栓”按钮。

图钉交互： 点击地图上消防栓图钉，立即弹出信息卡，不跳转页面。

视觉：

图钉编码： 绿色=正常，红色=损坏，灰色=状态未知。

高对比度模式： 设置中提供“高对比度”开关，增强户外可视性。

②设施详情卡片：

内容： 以卡片形式从屏幕底部向上滑出。包含：消防栓ID、状态标签、最后检查时间、工作压力、现场照片（可左右滑动查看）、直线距离。

操作： 提供“导航”按钮，点击后调用系统地图App并传入目标坐标。

③数据更新界面：

触发： 在Wi-Fi环境下自动检测，或在设置中手动触发。

展示： 清晰显示当前数据版本、最新版本、更新包大小、下载进度条。

**（3）Web管理端**

①登录页：

提供角色选择下拉框，不同的角色登录后看到的功能模块和数据进行权限控制。

②局长看板 / 数据总览：

布局： 采用Dashboard布局，结合地图和数据图表。

左侧面板： 关键指标卡（KPI），如：消防栓总数、正常率、本月采集进度。

中部主区域： 全市地图，使用热力图或聚类点显示消防栓分布密度。

右侧面板： 图表区，如“状态分布饼图”、“各区域采集进度条形图”。

③数据审核页面：

布局： 左右分栏或上下标签页结构。

左侧/上部： 待审核数据列表，可筛选“来源”（AI/人工）和“置信度”。

右侧/下部： 选中某条记录后，详细展示其所有信息（坐标、照片、属性），并提供“通过”、“驳回”、“修改”操作按钮。地图同步高亮显示该记录位置。

④系统管理页面：

用户管理： 表格形式展示用户列表，支持按角色筛选，提供“新增”、“禁用”、“重置密码”操作。

角色与权限： 以矩阵形式配置不同角色对功能模块和数据字段的访问权限。

## 2.6 关键算法技术选型

### 2.6.1 数据清洗与空间去重算法

（1）技术选型： DBSCAN (Density-Based Spatial Clustering of Applications with Noise)。

（2）选型理由： 相比于K-Means等算法，DBSCAN不需要预设聚类数量，能发现任意形状的簇，并能有效识别噪声点（即独立的、非重复的消防栓），非常适合处理空间位置上非均匀分布的消防栓数据。

（3）详细实现方案：

①数据准备： 从数据库中读取所有消防栓的经纬度坐标（WGS84）。

②参数调优：

eps (ε)： 邻域距离阈值，设置为 5-10米（根据GPS精度和实际业务需求调整）。代表两个消防栓被视为“邻近”的最大距离。

min_samples： 形成核心点所需的最小样本数，设置为 2。即一个簇内至少有两个消防栓才被认为是重复数据群。

③执行聚类： 使用PostGIS的ST_ClusterDBSCAN窗口函数或Python的scikit-learn库在服务端执行算法。

④后处理：对每个聚类，计算其几何中心，或选择置信度最高、数据最完整的一条记录作为主记录。

将其余记录标记为“已合并”，并将其数据（如多角度照片）关联到主记录上，随后在查询中只显示主记录。

1.  输出： 生成一个“消防栓簇”列表及对应的主记录，完成数据去重。

### 2.6.2AI消防栓识别算法

（1）技术选型： YOLOv8。

（2）选型理由： YOLO系列算法在速度和精度上取得了良好平衡。YOLOv8是当前最先进的版本，提供了更好的准确性和更丰富的模型尺寸（从nano到xlarge），便于在服务端部署高性能模型或在移动端部署轻量级模型。

（3）详细实现方案：

①模型训练：

数据标注： 收集大量消防栓图像，使用标注工具（如LabelImg）进行边界框标注。

模型选择： 初始训练使用预训练模型（如YOLOv8m）进行迁移学习，以加快收敛速度。

数据增强： 采用旋转、缩放、亮度调整、添加噪声等方法扩充数据集，提升模型鲁棒性。

②服务端部署：

使用FastAPI或Django构建RESTful API。

接口接收视频流帧或图片，调用加载好的YOLOv8模型进行推理。

返回结果为JSON格式，包含识别到的消防栓边界框坐标、置信度及类别。

③性能优化： 可使用TensorRT或OpenVINO对模型进行加速，以满足视频流实时处理的需求。

### 2.6.3 离线路径规划算法

（1）技术选型： OSRM (Open Source Routing Machine) + 预计算数据。

（2）选型理由： OSRM是专为道路网络设计的高性能路由引擎，支持离线运行，计算结果准确可靠，符合消防业务对路径规划的实际需求。

（3）详细实现方案：

①数据准备： 下载中山市的OpenStreetMap（.osm.pbf格式）数据。

②引擎部署与数据预处理：在服务器上部署OSRM后端服务，使用osrm-extract和osrm-partition/osrm-customize工具链处理OSM数据，生成适用于步行模式的路由图文件（.osrm文件）。

③集成方式：将生成的路由数据文件打包进离线数据包。在消防离线端集成OSRM Android/iOS API或使用HTTP请求调用本地OSRM服务。请求示例：http://127.0.0.1:5000/route/v1/foot/{经度1},{纬度1};{经度2},{纬度2}?steps=true

④输出： 解析返回的JSON，获取路径坐标序列，并使用地图SDK在地图上绘制为折线。

2.6.4 增量数据同步算法

（1）技术选型： 基于版本清单与文件哈希的差分同步机制。

（2）选型理由： 此方法轻量、可靠，无需在客户端维护复杂的状态逻辑，广泛应用于软件和资源更新。

（3）详细实现方案：

①清单文件（Manifest）：

服务端为每个离线数据包维护一个manifest.json文件，内容包含：

{

"version": "20241025_1",

"files": {

"map.mbtiles": {"hash": "a1b2c3...", "size": 10485760},

"hydrants.sqlite": {"hash": "d4e5f6...", "size": 524288},

...

}

}

②客户端同步流程：

启动时，客户端向服务器请求最新版本的manifest.json。

与本地存储的旧manifest.json进行对比。

对于hash值不一致或本地不存在的文件，加入下载列表。

下载完成后，用新文件替换旧文件，并更新本地版本清单。

③优化：

压缩： 对所有文件使用高压缩率的算法（如brotli或zstd）。

断点续传： 在HTTP请求头中使用Range参数实现。

# 3 详细设计

## 3.1 系统组件详细设计

本系统采用“B/S + C/S”混合架构，针对不同用户场景拆分核心组件，各组件通过接口实现数据交互，确保系统模块化、可扩展，同时满足离线操作、地图交互等关键需求。系统整体组件架构分为客户端组件、服务端组件、数据支撑组件三大部分，具体设计如下：

### 3.1.1 客户端组件设计

客户端包含“移动终端组件”（面向消防战士、数据采集人员）和“Web管理端组件”（面向系统管理员），核心组件及功能如下：

1\. 移动终端核心组件

地图引擎组件功能：负责地图加载、设备标注、位置定位、步行导航等核心地图交互，集成离线地图模块，支持预下载中山市地图数据。

技术选型：高德地图SDK（支持离线地图、步行导航），适配Android和iOS双系统。

关键设计：离线地图数据按行政区域拆分，单个区域数据压缩至50MB以内，支持Wi-Fi环境下自动更新；设备标注采用自定义图标（消防车用红色图标、消防栓用蓝色图标），标注位置误差控制在10米内。

数据采集组件功能：支持数据采集人员现场录入消防栓信息（位置、照片、工作压力、拍摄时间），自动关联采集设备的GPS位置，减少手动输入误差。

关键设计：照片拍摄支持自动压缩（分辨率调整为1080P），避免占用过多存储；采集表单设置必填项（位置、照片、压力值），确保数据完整性。

离线数据管理组件功能：负责离线状态下的数据存储、查询、同步，确保消防战士在无网络环境下可正常使用核心功能。

关键设计：采用SQLite本地数据库存储离线数据，数据同步策略为“网络恢复后增量同步”，避免重复传输；离线操作日志记录用户行为，同步时优先上传关键数据（如新增消防栓信息）。

权限控制组件功能：基于角色分配操作权限，消防战士角色默认仅开放“查询、导航”权限，数据采集人员开放“采集、编辑”权限。

关键设计：权限信息本地缓存，登录时与服务端校验权限有效性，防止权限篡改。

2\. Web管理端核心组件

用户管理组件：支持新增、编辑用户信息，分配角色权限（如“系统管理员”“数据审核员”），记录用户登录日志。

数据审核组件：对采集人员提交的消防设施数据进行审核，支持“通过”“驳回（附理由）”操作，审核通过后数据才同步至公共数据库。

统计分析组件：按区域统计消防设施覆盖率、设备新旧程度（基于拍摄时间和维护记录），生成可视化报表（柱状图、热力图）。

### 3.1.2 服务端组件设计

服务端采用微服务架构，拆分核心业务模块，确保高可用性和可扩展性，核心组件如下：

**接口网关组件**功能：统一管理客户端请求入口，实现请求路由、权限校验、流量控制（防止恶意请求）。

技术选型：Spring Cloud Gateway，支持动态路由配置。

**设备数据服务组件**功能：处理消防设施数据的增删改查，提供“按位置查询周边设备”“按设备类型筛选”等接口，支持模糊查询和精准查询。

关键设计：采用Redis缓存高频查询数据（如热门区域消防栓信息），查询响应时间控制在500ms以内。

**数据同步服务组件**功能：负责客户端与服务端的数据同步，处理离线数据的增量上传，解决消防设施状态动态更新问题。

关键设计：采用“定时轮询+主动推送”结合的方式，服务端定时向客户端推送设备状态变更信息（如消防栓损坏通知），客户端同步周期可配置（默认1小时）。

**文件存储服务组件**功能：存储消防设施照片、用户头像等文件数据，提供文件上传、下载、预览接口。

**技术选型**：阿里云OSS，支持文件防盗链和访问权限控制。

### 3.1.3 数据支撑组件设计

**数据库组件**：采用“关系型数据库+缓存”架构，MySQL存储结构化数据（用户信息、设备基础信息），Redis缓存高频访问数据。

**消息队列组件**：采用RabbitMQ处理异步任务（如数据同步通知、报表生成），避免服务阻塞，提升系统响应效率。

## 3.2 数据库详细设计

数据库设计遵循“第三范式”，减少数据冗余，同时结合系统查询需求设计索引，提升查询性能。核心数据库表结构如下，所有表均默认包含“创建时间、更新时间、删除标志”字段，支持数据软删除。

### 3.2.1 核心表结构设计

**用户信息表（sys_user）**

|     |     |     |     |     |
| --- | --- | --- | --- | --- |
| 字段名 | 数据类型 | 主键/外键 | 字段说明 | 约束条件 |
| user_id | BIGINT | 主键  | 用户唯一标识 | 自增，非空 |
| username | VARCHAR(50) | \-  | 登录账号 | 唯一，非空 |
| password | VARCHAR(100) | \-  | 加密后的密码 | 非空，采用BCrypt加密 |
| real_name | VARCHAR(20) | \-  | 真实姓名 | 非空  |
| role_id | BIGINT | 外键（关联sys_role.role_id） | 角色ID | 非空  |
| phone | VARCHAR(11) | \-  | 联系电话 | 符合手机号格式 |

**角色表（sys_role）**

|     |     |     |     |     |
| --- | --- | --- | --- | --- |
| 字段名 | 数据类型 |     | 主键/外键 | 字段说明 |     | 约束条件 |
| role_id | BIGINT | 主键  | 角色唯一标识 |     | 自增，非空 |     |
| role_name | VARCHAR(30) | \-  | 角色名称 |     | 唯一，非空（如“消防战士”“数据采集员”） |     |
| permission | VARCHAR(200) | \-  | 权限标识，多个用逗号分隔 |     | 非空<br><br>（如“query:device,navigate:fireHydrant”） |     |

**消防设施表（fire_facility）**

说明：存储消防栓、消防车等设备信息，通过“facility_type”字段区分类型

|     |     |     |     |     |
| --- | --- | --- | --- | --- |
| 字段名 | 数据类型 | 主键/外键 | 字段说明 | 约束条件 |
| facility_id | BIGINT | 主键  | 设备唯一标识 | 自增，非空 |
| facility_name | VARCHAR(100) | \-  | 设备名称 | 非空（如“中山大道消防栓-001”） |
| facility_type | TINYINT | \-  | 设备类型（1-消防栓，2-消防车） | 非空，取值范围1-2 |
| longitude | DECIMAL(10,6) | \-  | 经度  | 非空，定位精度支持10米要求 |
| latitude | DECIMAL(10,6) | \-  | 纬度  | 非空，同经度精度 |
| address | VARCHAR(200) | \-  | 详细地址 | 非空  |
| status | TINYINT | \-  | 设备状态（1-正常，2-损坏，3-维修中） | 非空，默认1 |
| shoot_time | DATETIME | \-  | 照片拍摄时间 | 非空（针对消防栓） |
| pressure | DECIMAL(5,2) | \-  | 工作压力（MPa） | 非空（针对消防栓） |
| special_type | VARCHAR(50) | \-  | 特殊类型（如“超高层高压”） | 可为空，后续版本扩展 |
| collector_id | BIGINT | 外键（关联sys_user.user_id） | 采集人员ID | 非空  |
| audit_status | TINYINT | \-  | 审核状态（0-待审核，1-已通过，2-已驳回） | 非空，默认0 |

**设备照片表（fire_facility_photo）**

|     |     |     |     |     |
| --- | --- | --- | --- | --- |
| 字段名 | 数据类型 | 主键/外键 | 字段说明 | 约束条件 |
| photo_id | BIGINT | 主键  | 照片唯一标识 | 自增，非空 |
| facility_id | BIGINT | 外键（关联fire_facility.facility_id） | 关联设备ID | 非空  |
| photo_url | VARCHAR(500) | \-  | 照片存储URL（阿里云OSS地址） | 非空  |
| photo_desc | VARCHAR(100) | \-  | 照片描述（如“正面照”“压力表特写”） | 可为空 |

**离线操作日志表（offline_operation_log）**

|     |     |     |     |     |
| --- | --- | --- | --- | --- |
| 字段名 | 数据类型 | 主键/外键 | 字段说明 | 约束条件 |
| log_id | BIGINT | 主键  | 日志唯一标识 | 自增，非空 |
| user_id | BIGINT | 外键（关联sys_user.user_id） | 操作人ID | 非空  |
| operation_type | VARCHAR(20) | \-  | 操作类型（如“查询设备”“采集数据”） | 非空  |
| operation_content | VARCHAR(500) | \-  | 操作内容（如“查询中山大道周边消防栓”） | 非空  |
| operation_time | DATETIME | \-  | 操作时间 | 非空  |
| sync_status | TINYINT | \-  | 同步状态（0-未同步，1-已同步） | 非空，默认0 |

### 3.2.2 索引设计

为提升查询性能，针对高频查询字段设计以下索引：

消防设施表（fire_facility）：建立联合索引（longitude, latitude, facility_type），支持“按位置查询周边设备”的高效检索；建立单字段索引（audit_status），优化数据审核查询。

用户信息表（sys_user）：建立索引（username），提升登录查询速度；建立索引（role_id），优化按角色筛选用户的场景。

设备照片表（fire_facility_photo）：建立索引（facility_id），确保通过设备ID查询照片时的效率。

### 3.2.3 数据库优化策略

分表策略：后续全省推广时，消防设施表按“城市编码”分表存储，避免单表数据量过大导致查询缓慢。

数据备份：采用“每日全量备份+实时增量备份”策略，全量备份数据保留30天，确保数据安全。

读写分离：系统用户量增长后，部署主从数据库，主库负责写入操作，从库负责查询操作，提升并发处理能力。

## 3.3 用户界面详细设计

用户界面设计遵循“简洁高效、贴合业务场景”原则，针对不同角色（消防战士、数据采集人员、系统管理员）设计专属界面，确保操作流程符合用户习惯，核心界面设计如下：

### 3.3.1 移动终端界面设计（重点面向消防战士和采集人员）

移动终端界面采用“底部Tab+顶部搜索”布局，核心界面包括登录页、地图主页、设备详情页、数据采集页，适配手机和Pad设备（Pad端支持分屏显示地图和设备列表）。

**1\. 登录界面**

核心元素：系统Logo（顶部居中）、登录账号输入框（提示“请输入工号”）、密码输入框（带隐藏/显示密码按钮）、“记住密码”复选框、“登录”按钮（底部居中，蓝色主色调，禁用状态为灰色）、“忘记密码”链接（登录按钮下方）。

交互逻辑：输入账号后失去焦点时校验格式（工号为6位数字）；密码输入长度不少于6位；点击登录后，若网络异常提示“当前网络不可用，将进入离线模式”，离线模式下仅可使用缓存数据。

设计规范：输入框边框默认灰色，获取焦点时变为蓝色；错误提示文字为红色，位于输入框下方（如“工号格式错误”）。

**2\. 地图主页（消防战士核心界面）**

布局结构：

顶部：搜索栏（提示“请输入火警位置”）、“定位”按钮（获取当前位置）、“筛选”按钮（按设备类型筛选）。

中间：地图显示区域（占屏幕70%），默认显示当前位置周边1公里内的消防设施，设备图标按类型区分（红色消防车、蓝色消防栓），点击图标弹出设备名称和状态提示。

底部：Tab栏（“地图”“我的”两个选项，当前页Tab文字加粗并加蓝色下划线）。

核心交互：搜索位置后，地图自动定位到该位置，高亮显示周边500米内的消防栓，弹出“周边消防栓共X个，点击查看详情”提示。

长按地图空白处，弹出“导航至此处”按钮，支持步行导航规划。

离线模式下，地图顶部显示橙色“离线模式”提示条，点击可查看离线数据更新时间。

**3\. 设备详情页**

布局结构：顶部：返回按钮（左侧）、设备名称（居中，如“中山大道消防栓-001”）、“分享”按钮（右侧）。

中间：照片展示区（轮播图形式，支持左右滑动，显示设备不同角度照片，底部显示照片拍摄时间）、设备信息列表（图标+文字组合，如“📍 地址：中山市XX区中山大道123号”“⚡ 压力：0.8MPa”“📅 状态：正常”）。

底部：“步行导航”按钮（蓝色，占屏幕宽度80%，居中）、“上报问题”按钮（橙色，导航按钮下方，小尺寸）。

交互逻辑：点击“步行导航”按钮，跳转至地图导航界面，显示从当前位置到设备的步行路线；点击“上报问题”，弹出选择框（“损坏”“移位”“其他”），选择后可输入问题描述并提交。

**4\. 数据采集页（采集人员专属界面）**

布局结构：顶部：返回按钮、“消防设施采集”标题。

中间：表单区域（按顺序排列）：设备类型选择（下拉框，默认“消防栓”）；

位置获取（“自动获取位置”按钮，点击后获取GPS位置并显示经纬度，支持手动修改）；

详细地址输入框（自动根据经纬度关联，支持手动编辑）；

工作压力输入框（带单位“MPa”，仅允许输入数字和小数点）；

照片上传区（“点击拍摄或上传”提示文字，支持多图上传，每张照片可添加描述）；

底部：“提交审核”按钮（蓝色，禁用状态下提示“请完善必填项”）。

交互逻辑：必填项未填写时，提交按钮禁用；提交后显示“提交成功，等待审核”提示，并跳转至地图主页；若网络异常，提示“离线保存成功，网络恢复后自动提交”。

### 3.3.2 Web管理端界面设计（面向系统管理员）

Web管理端采用“左侧菜单+顶部导航+中间内容区”经典后台布局，支持响应式设计，核心界面包括首页、用户管理页、数据审核页、统计分析页。

1\. 首页（控制台）

核心元素：

顶部：系统名称、当前登录用户、退出按钮、消息通知图标。

中间：数据概览卡片（2行2列布局），包括“总设备数”“待审核数据数”“在线用户数”“本月采集量”，每个卡片显示数字和环比增长率（如“总设备数：1258 ↑5.2%”），卡片采用不同色系区分。

底部：区域设备覆盖率热力图（左侧）、近期数据采集趋势图（右侧，折线图，显示近7天采集量）。

交互逻辑：点击数据概览卡片，跳转至对应详情页；热力图支持按区域筛选，鼠标悬浮显示该区域设备数量和覆盖率。

2\. 数据审核页

布局结构：顶部：搜索栏（支持按采集人、设备类型、地址搜索）、“批量审核”按钮。

## ****3.4 接口详细设计****

本系统接口遵循RESTful风格，使用HTTPS协议进行通信，数据交换格式为JSON。所有请求均需在Header中携带认证令牌：**Authorization: Bearer {jwt_token}**。

### ****3.4.1 外部接口设计****

**1\. 高德地图API**

**用途：** 地址解析与逆地址解析、在线地图瓦片加载、在线路径规划。

**调用方式：** HTTP GET/POST

**关键接口示例（逆地理编码）：**

**请求：** **GET https://restapi.amap.com/v3/geocode/regeo?key=&lt;您的key&gt;&location=113.3950,22.5010**

**响应：** 包含结构化地址信息的JSON数据。

**2\. 阿里云OSS服务**

**用途：** 消防设施照片、用户头像等文件的存储与管理。

**调用方式：** OSS SDK (PUT, GET, DELETE操作)

**流程：** 客户端向业务服务器申请上传凭证，业务服务器校验权限后向OSS申请并返回临时上传凭证，客户端使用该凭证直接上传文件至OSS。

### ****3.4.2 内部接口设计****

**1\. 设备数据服务 - 周边消防设施查询接口**

**接口地址：** **GET /api/v1/facilities/nearby**

**功能描述：** 根据用户位置，查询周边指定范围内的消防设施。

**请求参数：**

|     |     |     |     |
| --- | --- | --- | --- |
| 参数名 | 类型  | 必填  | 说明  |
| **longitude** | Number | 是   | 中心点经度 |
| **latitude** | Number | 是   | 中心点纬度 |
| **radius** | Integer | 否   | 搜索半径(米)，默认500 |
| **facilityType** | Integer | 否   | 设施类型 (1:消防栓, 2:消防车) |
| **status** | Integer | 否   | 设施状态 (1:正常, 2:损坏) |

**成功响应 (200):**

{

"code": 200,

"message": "success",

"data": {

"facilities": \[

{

"facilityId": 12345,

"facilityName": "中山大道消防栓-001",

"facilityType": 1,

"longitude": 113.3960,

"latitude": 22.5015,

"address": "中山市石岐区民生路XXX号",

"status": 1,

"pressure": 0.80,

"distance": 150.2,

"mainPhotoUrl": "https://oss.domain.com/photo1.jpg"

}

\]

}}

**2\. 数据同步服务 - 离线数据同步接口**

**接口地址：** **POST /api/v1/sync/upload**

**功能描述：** 移动端在联网后，将离线期间采集的数据和操作日志同步至服务器。

**请求参数：**

{

"collectedFacilities": \[

{

"localId": "local_uuid_123", _// 本地临时ID_

"facilityName": "新建消防栓",

"longitude": 113.4000,

"latitude": 22.5000,

"pressure": 0.75,

"photos": \["temp_photo_url1", "temp_photo_url2"\],

"collectTime": "2023-10-27 10:30:00"

}

\],

"operationLogs": \[

{"logId": 1, "operationType": "QUERY", ...}

\]}

**成功响应 (200):**

{

"code": 200,

"message": "同步成功",

"data": {

"syncedFacilities": \[

{"localId": "local_uuid_123", "serverId": 12346}

\],

"syncedLogs": \[1, 2, 3\]

}}

**3\. 数据审核服务 - 审核数据列表查询接口**

**接口地址：** **GET /api/v1/audit/pending-list**

**功能描述：** Web管理端获取待审核的数据列表。

**请求参数：** **page**, **size**, **collectorName** (可选)

**成功响应 (200):**

{

"code": 200,

"message": "success",

"data": {

"list": \[

{

"facilityId": 12345,

"facilityName": "待审核消防栓",

"collectorName": "张三",

"collectTime": "2023-10-27 10:30:00",

"mainPhotoUrl": "https://...",

"address": "中山市..."

}

\],

"total": 150

}}

## ****3.5 算法详细设计****

### ****3.5.1 空间数据去重算法****

**1\. 算法目标：**防止因多次采集或AI误识别，导致同一消防栓在数据库中存在多条重复记录。

**2\. 算法选择：**基于**Haversine公式**的距离计算与阈值判断。

**3\. 输入：**新采集的消防栓坐标 **(lat1, lon1)**，数据库中原有消防栓坐标集合。

**4\. 输出：**判定结果：**重复** 或 **不重复**。若重复，返回重复的设施ID。

**5\. 详细步骤：**

1\. 从数据库**fire_facility**表中查询出状态正常且未合并的所有消防栓坐标 **(lat2, lon2)**。

2\. 遍历查询结果，对每一个已有设施，使用Haversine公式计算与新采集点的球面距离。 **distance = 2 \* R \* arcsin( sqrt( sin²(Δφ/2) + cos(φ1) \* cos(φ2) \* sin²(Δλ/2) ) )**其中**R**为地球半径，**Δφ**和**Δλ**分别为纬度差和经度差（弧度制）。

3\. 设定一个距离阈值**D**（根据需求规格，**D = 10米**）。

4\. 如果**distance < D**，则判定为重复。

5\. 找到所有重复记录后，执行**合并策略**：保留置信度最高（AI采集）或信息最全（字段填充率最高）的一条记录，将其他记录的**is_merged**字段标记为**True**，并关联到保留记录的ID。

**6\. 性能优化：** 在数据库层面，利用**PostGIS的ST_DWithin函数**在空间索引上进行快速初筛，避免全表扫描和计算所有点的距离。  
SQL示例：**SELECT facility_id FROM fire_facility WHERE ST_DWithin(geom, ST_MakePoint(?, ?)::geography, 10);**

### ****3.5.2 AI图像识别算法（消防栓检测）****

**1\. 算法目标：**从车辆摄像头视频流或图片中，自动识别并定位消防栓。

**2\. 模型选型：YOLOv8s**。因其在速度和精度上取得了良好平衡，适合移动端（集成）或服务端部署的实时检测任务。

**3\. 算法流程：**

**数据预处理：**将输入图像缩放至固定尺寸（如640x640），并归一化像素值。

**模型推理：**将预处理后的图像输入YOLOv8模型，输出边界框（Bounding Box）、置信度（Confidence）和类别（Class）。

**后处理：**应用**非极大值抑制（NMS）** 过滤掉重叠的、低置信度的冗余检测框。 设定一个置信度阈值（如0.85），仅输出高于此阈值的检测结果。 将检测框的中心点坐标，结合GPS定位信息和相机参数（可选），换算成消防栓的经纬度。**4\. 集成部署：**使用**FastAPI**框架将训练好的YOLOv8模型封装成RESTful API服务。接口接收图片文件，返回识别结果（包括是否有消防栓、置信度、以及计算出的经纬度）。

## ****3.6 异常和错误详细设计****

### ****3.6.1 全局异常处理机制****

系统采用统一的全局异常处理器（如Spring Boot的**@ControllerAdvice**）来捕获和处理所有未处理的异常。该处理器会将各种异常转换为结构化的错误响应JSON返回给客户端。

**统一错误响应格式：**

{

"code": 5001,

"message": "具体的错误描述信息，可供前端直接展示给用户。",

"data": null,

"timestamp": 1698401234567,

"path": "/api/v1/facilities/nearby"}

### ****3.6.2 自定义异常类体系****

定义一套业务异常类，用于抛出明确的、可被全局处理器捕获的业务错误。

**1.BusinessException**：所有业务异常的基类。

**2\. AuthenticationException** (code: 401)：认证失败，如Token无效、过期。

**3\. PermissionDeniedException** (code: 403)：权限不足，访问被拒绝。

**4\. ResourceNotFoundException** (code: 404)：请求的资源（如消防栓、用户）不存在。

**5\. InvalidParameterException** (code: 400)：请求参数无效或不合法。

**6\. DataDuplicateException** (code: 4001)：数据重复（如去重算法发现重复消防栓）。

**7\. AIServiceException** (code: 5001)：调用AI识别服务失败或超时。

**8\. FileUploadException** (code: 5002)：文件上传至OSS失败。

**9\. OfflineDataSyncException** (code: 5003)：离线数据同步过程中发生错误。

### ****3.6.3 错误码规范****

|     |     |     |
| --- | --- | --- |
| 错误码范围 | 分类  | 说明  |
| 200 | 成功  | 请求成功 |
| 400 | 客户端请求错误 | 参数错误、数据验证失败等 |
| 401 | 未授权 | 用户未登录或Token无效 |
| 403 | 禁止访问 | 用户权限不足 |
| 404 | 资源未找到 | 请求的URL或资源不存在 |
| 405 | 方法不允许 | 错误的HTTP方法 |
| 415 | 不支持的媒体类型 |     |
| 500 | 服务器内部错误 | 系统未知异常 |
| 5001 - 5099 | 业务逻辑异常 | 自定义的业务异常码 |

### ****3.6.4 特定场景异常处理****

**GPS定位失败：**移动端捕获系统定位异常，返回**LocationServiceException**，提示用户“获取位置失败，请检查GPS设置或网络连接”。

**网络异常：**移动端发起请求时，若检测到无网络，应抛出**NetworkUnavailableException**，并自动切换至离线模式，使用本地缓存数据。

**数据库操作失败：**服务端捕获数据库异常（如唯一约束冲突、连接超时），记录详细日志后，向上抛出统一的**DataAccessException**，对外返回“系统繁忙，请稍后重试”。

**第三方服务异常：**调用高德地图或OSS失败时，捕获异常并根据情况决定重试或直接抛出**ThirdPartyServiceException**，告知用户“服务暂时不可用”。